<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StarTalk - Character Custom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --kakao-yellow: #FEE500; --kakao-bg: #BACEE0; }
        .kakao-bubble-me { @apply bg-[#FEE500] text-black rounded-l-lg rounded-br-lg p-2 shadow-sm max-w-[70%] text-sm; }
        .kakao-bubble-other { @apply bg-white text-black rounded-r-lg rounded-bl-lg p-2 shadow-sm max-w-[70%] text-sm; }
        .avatar { @apply w-12 h-12 rounded-2xl border border-black/5 flex items-center justify-center text-2xl bg-gray-100 overflow-hidden; }
        #profile-modal { @apply fixed inset-0 bg-black/60 flex items-center justify-center z-[60] hidden; }
        .char-option { @apply w-16 h-16 flex items-center justify-center text-4xl cursor-pointer hover:bg-gray-100 rounded-xl transition-all border-2 border-transparent; }
        .char-selected { @apply border-[#FEE500] bg-yellow-50; }
    </style>
</head>
<body class="bg-white text-[#3C1E1E] h-screen overflow-hidden flex">

<div id="profile-modal">
    <div class="bg-white p-6 rounded-3xl w-80 shadow-2xl">
        <h3 class="text-lg font-bold mb-4 text-center">ìºë¦­í„° ê¾¸ë¯¸ê¸°</h3>
        <div class="flex flex-wrap justify-center gap-2 mb-6" id="char-selector">
            <div class="char-option" onclick="selectChar('ğŸ¶')">ğŸ¶</div>
            <div class="char-option" onclick="selectChar('ğŸ±')">ğŸ±</div>
            <div class="char-option" onclick="selectChar('ğŸ»')">ğŸ»</div>
            <div class="char-option" onclick="selectChar('ğŸ°')">ğŸ°</div>
            <div class="char-option" onclick="selectChar('ğŸ¦Š')">ğŸ¦Š</div>
            <div class="char-option" onclick="selectChar('ğŸ¥')">ğŸ¥</div>
            <div class="char-option" onclick="selectChar('ğŸ¸')">ğŸ¸</div>
            <div class="char-option" onclick="selectChar('ğŸ¤–')">ğŸ¤–</div>
        </div>
        <button onclick="saveProfile()" class="w-full bg-[#FEE500] py-3 rounded-xl font-bold hover:brightness-95">ì €ì¥í•˜ê¸°</button>
        <button onclick="closeProfile()" class="w-full py-2 mt-2 text-gray-400 text-sm">ì·¨ì†Œ</button>
    </div>
</div>

<div id="auth-overlay" class="fixed inset-0 bg-[#FEE500] flex items-center justify-center z-50">
    <div class="w-72 flex flex-col space-y-3">
        <h1 class="text-5xl font-black text-center mb-8">StarTalk</h1>
        <input id="auth-id" type="text" placeholder="ì•„ì´ë””" class="p-3 rounded-md outline-none border border-gray-300">
        <input id="auth-pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="p-3 rounded-md outline-none border border-gray-300">
        <button id="btn-login" class="bg-[#3C1E1E] text-white py-3 rounded-md font-bold">ë¡œê·¸ì¸</button>
        <button id="btn-signup" class="text-xs text-[#3C1E1E] font-bold opacity-70 text-center">íšŒì›ê°€ì…</button>
    </div>
</div>

<nav class="w-16 bg-[#EBEBEB] flex flex-col items-center py-4 shrink-0 border-r border-gray-300">
    <div class="py-4 cursor-pointer text-2xl opacity-100">ğŸ‘¤</div>
    <div class="mt-auto pb-4 cursor-pointer opacity-30 hover:opacity-100" id="btn-logout">ğŸšª</div>
</nav>

<aside class="w-72 bg-white flex flex-col shrink-0 border-r border-gray-200">
    <div class="p-5 flex justify-between items-center">
        <h2 class="text-xl font-bold">ì¹œêµ¬</h2>
        <button onclick="addFriendPrompt()" class="text-xl">â•</button>
    </div>
    <div onclick="openProfile()" class="px-5 py-3 flex items-center border-b mb-2 cursor-pointer hover:bg-gray-50 transition-all">
        <div class="avatar mr-3" id="my-avatar">ğŸ‘¤</div>
        <div class="flex flex-col">
            <span class="font-bold text-sm" id="display-my-id">ë¡œë“œ ì¤‘...</span>
            <span class="text-[10px] text-gray-400">ë‚´ í”„ë¡œí•„ í¸ì§‘í•˜ê¸°</span>
        </div>
    </div>
    <div id="friend-list" class="flex-1 overflow-y-auto"></div>
</aside>

<main class="flex-1 flex flex-col bg-[#BACEE0]">
    <header class="h-14 px-4 flex items-center shrink-0 border-b border-black/5">
        <span id="active-chat-name" class="font-bold text-sm opacity-70">ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”</span>
    </header>
    <div id="chat-box" class="flex-1 p-4 overflow-y-auto flex flex-col space-y-4"></div>
    <form id="chat-form" class="bg-white p-2 flex items-end space-x-2 border-t">
        <textarea id="chat-input" rows="2" placeholder="ë©”ì‹œì§€ ì…ë ¥..." class="flex-1 outline-none text-sm resize-none p-2" disabled></textarea>
        <button type="submit" class="bg-[#FEE500] px-4 py-2 rounded text-xs font-bold">ì „ì†¡</button>
    </form>
</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, get, push, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDYQUyL1NK8FLLyg8rIhi-R2oUoNi3W_Ec",
        authDomain: "project-7315720285852881421.firebaseapp.com",
        databaseURL: "https://project-7315720285852881421-default-rtdb.firebaseio.com",
        projectId: "project-7315720285852881421",
        storageBucket: "project-7315720285852881421.firebasestorage.app",
        messagingSenderId: "1074221819506",
        appId: "1:1074221819506:web:fab0e5fda58b4175a7c4eb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let myId = "", tempChar = "ğŸ¶";
    let activeChatKey = null;

    onAuthStateChanged(auth, (user) => {
        if (user) {
            myId = user.email.split('@')[0];
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('display-my-id').innerText = myId;
            syncMyProfile();
            loadFriends();
        } else {
            document.getElementById('auth-overlay').style.display = 'flex';
        }
    });

    // [í”„ë¡œí•„ ì„¤ì • ê¸°ëŠ¥]
    window.openProfile = () => document.getElementById('profile-modal').style.display = 'flex';
    window.closeProfile = () => document.getElementById('profile-modal').style.display = 'none';
    window.selectChar = (char) => {
        tempChar = char;
        document.querySelectorAll('.char-option').forEach(el => el.classList.remove('char-selected'));
        event.currentTarget.classList.add('char-selected');
    };
    window.saveProfile = async () => {
        await set(ref(db, `users/${myId}/char`), tempChar);
        closeProfile();
    };

    function syncMyProfile() {
        onValue(ref(db, `users/${myId}/char`), (snap) => {
            const char = snap.val() || "ğŸ‘¤";
            document.getElementById('my-avatar').innerText = char;
        });
    }

    // [ì¹œêµ¬ ëª©ë¡ & ìºë¦­í„° í‘œì‹œ]
    function loadFriends() {
        onValue(ref(db, `friends/${myId}`), (snap) => {
            const list = document.getElementById('friend-list');
            list.innerHTML = '';
            snap.forEach(child => {
                const friendId = child.key;
                get(ref(db, `users/${friendId}/char`)).then(s => {
                    const char = s.val() || "ğŸ‘¤";
                    list.innerHTML += `
                        <div onclick="startChat('${friendId}', '${char}')" class="px-5 py-3 flex items-center hover:bg-gray-50 cursor-pointer">
                            <div class="avatar mr-3 text-lg">${char}</div>
                            <div class="text-sm font-medium">${friendId}</div>
                        </div>`;
                });
            });
        });
    }

    // [ì±„íŒ… ì‹œì‘]
    window.startChat = (friendId, char) => {
        const ids = [myId, friendId].sort();
        activeChatKey = `${ids[0]}_${ids[1]}`;
        document.getElementById('active-chat-name').innerText = `${char} ${friendId}ë‹˜ê³¼ ëŒ€í™” ì¤‘`;
        document.getElementById('chat-input').disabled = false;
        loadMessages(activeChatKey, friendId, char);
    };

    function loadMessages(chatKey, friendId, friendChar) {
        onValue(ref(db, `chats/${chatKey}`), (snap) => {
            const box = document.getElementById('chat-box');
            box.innerHTML = '';
            snap.forEach(m => {
                const d = m.val();
                const isMe = d.sender === myId;
                box.innerHTML += `
                    <div class="flex ${isMe ? 'flex-row-reverse' : 'flex-row'} items-start w-full gap-2">
                        <div class="w-8 h-8 rounded-lg bg-gray-200 flex items-center justify-center text-sm">
                            ${isMe ? '' : friendChar}
                        </div>
                        <div class="${isMe ? 'kakao-bubble-me' : 'kakao-bubble-other'}">
                            ${d.text}
                        </div>
                    </div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    // [ê¸°ë³¸ ì±„íŒ… ì „ì†¡ ë° ê°€ì… ë¡œì§]
    document.getElementById('chat-form').onsubmit = (e) => {
        e.preventDefault();
        const input = document.getElementById('chat-input');
        if (!input.value.trim() || !activeChatKey) return;
        push(ref(db, `chats/${activeChatKey}`), { text: input.value, sender: myId, timestamp: serverTimestamp() });
        input.value = '';
    };

    document.getElementById('btn-signup').onclick = async () => {
        const id = document.getElementById('auth-id').value.trim();
        const pw = document.getElementById('auth-pw').value;
        try {
            await createUserWithEmailAndPassword(auth, id + "@starchat.com", pw);
            await set(ref(db, `users/${id}`), { uid: auth.currentUser.uid, char: "ğŸ¶" });
            alert("ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ í•˜ì„¸ìš”.");
        } catch(e) { alert("ê°€ì… ì‹¤íŒ¨!"); }
    };

    document.getElementById('btn-login').onclick = async () => {
        const id = document.getElementById('auth-id').value.trim();
        const pw = document.getElementById('auth-pw').value;
        try { await signInWithEmailAndPassword(auth, id + "@starchat.com", pw); } catch(e) { alert("ë¡œê·¸ì¸ ì‹¤íŒ¨"); }
    };

    window.addFriendPrompt = async () => {
        const tid = prompt("ì¹œêµ¬ ì•„ì´ë””:");
        if (!tid || tid === myId) return;
        if ((await get(ref(db, `users/${tid}`))).exists()) {
            await set(ref(db, `friends/${myId}/${tid}`), true);
            alert("ì¶”ê°€ ì™„ë£Œ!");
        } else alert("ì—†ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.");
    };

    document.getElementById('btn-logout').onclick = () => signOut(auth);
</script>
</body>
</html>

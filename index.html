<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StarChat - All-in-One</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        .server-icon { @apply w-12 h-12 bg-[#313338] text-[#5865F2] rounded-[24px] flex items-center justify-center hover:bg-[#5865F2] hover:text-white transition-all cursor-pointer shadow-lg font-bold; }
        .active-server { border-radius: 16px !important; background-color: #5865F2 !important; color: white !important; }
        .channel-item { @apply flex items-center px-2 py-2 rounded cursor-pointer text-[#949BA4] hover:bg-[#35373C] hover:text-white transition-all text-sm mb-[2px] justify-between; }
        .active-channel { @apply bg-[#4f46e5] text-white !important; font-weight: bold; }
        #auth-overlay { @apply fixed inset-0 bg-black/90 flex items-center justify-center z-50; }
        .master-badge { @apply bg-gradient-to-r from-yellow-400 to-orange-500 text-white text-[9px] px-1 rounded ml-1 font-bold animate-pulse; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #1e1f22; border-radius: 10px; }
    </style>
</head>
<body class="bg-[#313338] text-[#DBDEE1] font-sans overflow-hidden">

<div id="auth-overlay">
    <div class="bg-[#313338] p-8 rounded-xl shadow-2xl w-80 flex flex-col space-y-4 border border-[#1E1F22]">
        <h2 class="text-3xl font-black text-[#5865F2] text-center italic tracking-tighter">STARCHAT</h2>
        <input id="auth-id" type="text" placeholder="ì•„ì´ë””" class="bg-[#1E1F22] p-3 rounded text-sm outline-none focus:ring-2 focus:ring-[#5865F2] text-white">
        <input id="auth-pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" class="bg-[#1E1F22] p-3 rounded text-sm outline-none focus:ring-2 focus:ring-[#5865F2] text-white">
        <button id="btn-login" class="bg-[#5865F2] hover:bg-[#4752C4] py-3 rounded-lg font-bold transition-all">ë¡œê·¸ì¸</button>
        <button id="btn-signup" class="text-xs text-gray-500 hover:text-white underline text-center">ì‹ ê·œ ê°€ì…</button>
    </div>
</div>

<div class="flex h-screen w-full">
    <nav class="w-[72px] bg-[#1E1F22] flex flex-col items-center py-3 space-y-2 shrink-0">
        <div onclick="location.reload()" class="server-icon border-2 border-[#5865F2] text-xs">HOME</div>
        <div class="w-8 h-[2px] bg-[#35363C] rounded-full my-1"></div>
        <div id="server-list" class="flex flex-col space-y-2"></div>
        <button id="join-code-btn" class="server-icon text-xl" title="ì½”ë“œë¡œ ì…ì¥">#</button>
        <button id="add-server-btn" class="server-icon text-2xl">+</button>
    </nav>

    <aside class="w-64 bg-[#2B2D31] flex flex-col shrink-0 border-r border-[#1E1F22]">
        <div class="h-12 px-4 flex items-center shadow-md font-bold text-white border-b border-[#1E1F22] justify-between">
            <span id="active-server-name" class="truncate">ì„œë²„ë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
            <button id="copy-code-btn" class="hidden text-[9px] bg-[#1E1F22] px-2 py-1 rounded hover:bg-gray-700">ì½”ë“œë³µì‚¬</button>
        </div>
        <div class="flex-1 overflow-y-auto p-4">
            <div class="text-[11px] font-bold text-[#949BA4] uppercase mb-2 flex justify-between items-center">
                <span>ì±„ë„ ë° ìŒì„±</span>
                <button id="add-channel-btn" class="hidden text-lg hover:text-white">+</button>
            </div>
            <div id="channel-list" class="mb-6"></div>
            <div class="text-[11px] font-bold text-[#949BA4] uppercase mb-2">ì˜¨ë¼ì¸ ìœ ì €</div>
            <div id="user-list" class="space-y-1"></div>
        </div>
        <div id="user-footer" class="p-3 bg-[#232428] border-t border-[#1E1F22] flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-[#5865F2] flex items-center justify-center text-[10px] font-bold">U</div>
                <span id="my-name" class="font-bold text-xs text-[#5865F2] truncate w-20"></span>
            </div>
            <button id="btn-logout" class="text-[10px] text-gray-500 hover:text-red-400 font-bold">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col bg-[#313338]">
        <header class="h-12 px-4 flex items-center shadow-sm border-b border-[#1E1F22] font-bold text-white justify-between">
            <div><span class="text-[#5865F2] mr-2">#</span><span id="active-channel-name">ì ‘ì† ëŒ€ê¸° ì¤‘</span></div>
            <div id="voice-status" class="text-[10px] text-gray-500 font-mono">MIC: OFF</div>
        </header>
        <div id="chat-box" class="flex-1 p-4 overflow-y-auto space-y-4"></div>
        <form id="chat-form" class="p-4 shrink-0">
            <input id="chat-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." class="bg-[#383A40] w-full p-3 rounded-lg outline-none text-sm text-white" disabled autocomplete="off">
        </form>
    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, remove, serverTimestamp, onDisconnect, query, orderByChild } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const MASTER_ID = "admin"; // <--- ë³¸ì¸ ì•„ì´ë””ë¡œ ë³€ê²½í•˜ì„¸ìš”

    const firebaseConfig = {
        apiKey: "AIzaSyDYQUyL1NK8FLLyg8rIhi-R2oUoNi3W_Ec",
        authDomain: "project-7315720285852881421.firebaseapp.com",
        databaseURL: "https://project-7315720285852881421-default-rtdb.firebaseio.com",
        projectId: "project-7315720285852881421",
        storageBucket: "project-7315720285852881421.firebasestorage.app",
        messagingSenderId: "1074221819506",
        appId: "1:1074221819506:web:fab0e5fda58b4175a7c4eb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let activeSid = null, activeCid = null, isAdmin = false;
    let myPeer = null, myStream = null;

    // ì¸ì¦ ë° ì„¸ì…˜ ì²´í¬
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const uid = user.uid;
            const myId = user.email.split('@')[0];
            const sessionRef = ref(db, `sessions/${uid}`);
            const newSessionId = Date.now().toString();
            
            localStorage.setItem('sc_session', newSessionId);
            await set(sessionRef, { sessionId: newSessionId });
            
            onValue(sessionRef, (snap) => {
                if (snap.val() && snap.val().sessionId !== localStorage.getItem('sc_session')) {
                    alert("ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ì—ì„œ ë¡œê·¸ì¸í•˜ì—¬ ì ‘ì†ì´ ì¢…ë£Œë©ë‹ˆë‹¤.");
                    signOut(auth);
                }
            });

            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('my-name').innerText = myId;
            loadServerList();
            selectServer('official', 'ìŠ¤íƒ€ì³‡ ë³¸ë¶€', 'admin');
        } else {
            document.getElementById('auth-overlay').style.display = 'flex';
        }
    });

    // íšŒì›ê°€ì…/ë¡œê·¸ì¸ ë¡œì§
    document.getElementById('btn-signup').onclick = async () => {
        const id = document.getElementById('auth-id').value.trim();
        const pw = document.getElementById('auth-pw').value;
        if(pw.length < 6) return alert("ë¹„ë²ˆì€ 6ì ì´ìƒ!");
        try {
            await createUserWithEmailAndPassword(auth, id + "@starchat.com", pw);
            alert("ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ í•˜ì„¸ìš”.");
        } catch(e) { alert("ì¤‘ë³µëœ ì•„ì´ë””ê±°ë‚˜ ê°€ì…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
    };

    document.getElementById('btn-login').onclick = async () => {
        const id = document.getElementById('auth-id').value.trim();
        const pw = document.getElementById('auth-pw').value;
        try { await signInWithEmailAndPassword(auth, id + "@starchat.com", pw); } catch(e) { alert("ì•„ì´ë””/ë¹„ë²ˆì„ í™•ì¸í•˜ì„¸ìš”."); }
    };

    document.getElementById('btn-logout').onclick = () => signOut(auth);

    // ë§ˆì´í¬(ìŒì„±) ê¸°ëŠ¥
    window.joinVoice = async (sid, cid) => {
        if (myStream) return alert("ì´ë¯¸ ë§ˆì´í¬ê°€ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
        try {
            myStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            myPeer = new Peer(auth.currentUser.uid + "_" + cid);
            
            myPeer.on('open', (id) => {
                const voiceRef = ref(db, `voice/${sid}/${cid}/${auth.currentUser.uid}`);
                set(voiceRef, { id: id, name: auth.currentUser.email.split('@')[0] });
                onDisconnect(voiceRef).remove();
                document.getElementById('voice-status').innerText = "MIC: ON";
                document.getElementById('voice-status').className = "text-[10px] text-green-400 font-bold animate-pulse";
            });

            myPeer.on('call', (call) => {
                call.answer(myStream);
                call.on('stream', (userStream) => { 
                    const audio = new Audio(); audio.srcObject = userStream; audio.play(); 
                });
            });

            onValue(ref(db, `voice/${sid}/${cid}`), (snap) => {
                snap.forEach((user) => {
                    if (user.key !== auth.currentUser.uid) {
                        const call = myPeer.call(user.val().id, myStream);
                        call.on('stream', (s) => { const a = new Audio(); a.srcObject = s; a.play(); });
                    }
                });
            });
            alert("ìŒì„± ì±„ë„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (e) { alert("ë§ˆì´í¬ ê¶Œí•œì„ ìŠ¹ì¸í•´ì£¼ì„¸ìš”."); }
    };

    // ì„œë²„ ì„ íƒ ë° ë¡œë“œ
    window.selectServer = (sid, name, ownerId) => {
        activeSid = sid;
        const myId = auth.currentUser?.email.split('@')[0];
        isAdmin = (myId === MASTER_ID || ownerId === auth.currentUser?.uid || ownerId === 'admin');
        
        document.getElementById('active-server-name').innerText = name;
        document.getElementById('copy-code-btn').style.display = 'block';
        document.getElementById('add-channel-btn').style.display = isAdmin ? 'block' : 'none';

        onValue(ref(db, `channels/${sid}`), (snap) => {
            const list = document.getElementById('channel-list'); list.innerHTML = '';
            if(!snap.exists() && isAdmin) push(ref(db, `channels/${sid}`), { name: "ê¸°ë³¸ì±„ë„" });
            snap.forEach(c => {
                const cid = c.key;
                list.innerHTML += `<div class="channel-item ${activeCid === cid ? 'active-channel' : ''}" onclick="window.loadChat('${sid}','${cid}','${c.val().name}')">
                    <span># ${c.val().name}</span>
                    <button onclick="event.stopPropagation(); window.joinVoice('${sid}','${cid}')" class="hover:text-green-400">ğŸ™ï¸</button>
                </div>`;
            });
        });

        onValue(ref(db, `sessions`), (snap) => {
            const ulist = document.getElementById('user-list'); ulist.innerHTML = '';
            snap.forEach(u => {
                ulist.innerHTML += `<div class="flex items-center text-xs p-1 text-gray-400">â— ì ‘ì† ì¤‘</div>`;
            });
        });
    };

    window.loadChat = (sid, cid, name) => {
        activeCid = cid;
        document.getElementById('active-channel-name').innerText = name;
        document.getElementById('chat-input').disabled = false;
        
        const chatQuery = query(ref(db, `messages/${sid}/${cid}`), orderByChild('timestamp'));
        onValue(chatQuery, (snap) => {
            const box = document.getElementById('chat-box'); box.innerHTML = '';
            snap.forEach(m => {
                const d = m.val();
                const isMaster = d.id === MASTER_ID;
                box.innerHTML += `<div class="flex flex-col">
                    <div class="flex items-center"><span class="font-bold text-xs ${isMaster?'text-yellow-400':'text-[#5865F2]'}">${d.id}</span>${isMaster?'<span class="master-badge">MASTER</span>':''}</div>
                    <div class="text-sm text-[#DBDEE1] mt-0.5">${d.text}</div>
                </div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    };

    document.getElementById('chat-form').onsubmit = (e) => {
        e.preventDefault();
        const input = document.getElementById('chat-input'); if(!input.value || !activeCid) return;
        push(ref(db, `messages/${activeSid}/${activeCid}`), {
            text: input.value, id: auth.currentUser.email.split('@')[0], timestamp: serverTimestamp()
        });
        input.value = '';
    };

    document.getElementById('join-code-btn').onclick = () => {
        const code = prompt("ì…ì¥ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if(code) selectServer(code, "ì½”ë“œ ì…ì¥ ì„œë²„", "");
    };

    document.getElementById('copy-code-btn').onclick = () => {
        navigator.clipboard.writeText(activeSid);
        alert("ì„œë²„ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ì„¸ìš”.");
    };

    document.getElementById('add-server-btn').onclick = () => {
        const n = prompt("ìƒˆ ì„œë²„ ì´ë¦„:");
        if(n) push(ref(db, 'server_list'), { name: n, initial: n[0], owner: auth.currentUser.uid });
    };

    document.getElementById('add-channel-btn').onclick = () => {
        const n = prompt("ìƒˆ ì±„ë„ ì´ë¦„:");
        if(n) push(ref(db, `channels/${activeSid}`), { name: n });
    };

    function loadServerList() {
        onValue(ref(db, 'server_list'), (snap) => {
            const list = document.getElementById('server-list'); list.innerHTML = '';
            snap.forEach(s => {
                const d = s.val();
                list.innerHTML += `<div onclick="selectServer('${s.key}','${d.name}','${d.owner}')" class="server-icon mb-2">${d.initial}</div>`;
            });
        });
    }
</script>
</body>
</html>
